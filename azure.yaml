# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: voltwrite
metadata:
  template: azure-chat@0.0.1
services:
  frontend:
    project: ./src
    language: ts
    host: appservice
infra:
  path: ./infra/dpc  # Point to custom infra path
  module: dpc_main   # Main bicep file name without .bicep extension
  parameters:
    # Use parametersFile to specify which bicepparam file to use
    parametersFile: clients/${clientId}/dpc_main.bicepparam
commands:
  deploy-client-complete:
    description: "Fully provision the client environment"
    inputs:
      - name: clientId
        description: "Client identifier"
        required: true
    run:
      windows:
        shell: pwsh
        run: |
          # Deploy infrastructure
          azd up --parameter clientId=${clientId}
          
          # Create app registration
          $webappname = azd env get-value AZURE_WEBAPP_NAME
          ./scripts/appreg_setup.ps1 -webappname $webappname

          # Remove outputs from the bicep deployment
          azd env unset APP_URL
          azd env unset AZURE_WEBAPP_NAME